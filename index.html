<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Playlist Curator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

    <h1>Playlist Curator</h1>

    <div id="app">

        <div class="debug" style="position:fixed;top:0;right:0;border:1px solid red;width:30%;" v-if="user.tokenDetails">
            <h3>Debug</h3>
            <br> Token: {{ user.tokenDetails.access_token }}
            <br> Expires In: {{ user.tokenDetails.expires_in }}
            <br> Token Type: {{ user.tokenDetails.token_type }}
        </div>

        <div class="explorer">
            <label>Search</label>
            <input type="text" id="searchString" v-model="search.string">
            <ul>
                <li v-for="result in search.results">
                    {{ result.name }} - {{ result.artists[0].name }}
                    <button v-on:click="selectTrack(result.uri)">Add</button>
                </li>
            </ul>
        </div>

        <div class="playlist">
            <h2>Playlist</h2>
            <label>Name: </label>
            <input type="text" id="playlistName" v-model="playlist.name">
            <ul>
                <li v-for="track in playlist.tracks">
                    {{ track }}
                </li>
            </ul>
        </div>

        <div class="controls">
            <button v-on:click="createPlaylist()">
                Create Playlist
            </button>
            <button v-on:click="addSongsToPlaylist()">
                Add Songs To Playlist
            </button>
            <button v-on:click="auth()" v-if="! authed">
                Auth
            </button>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>

    <script>
        // utility method
        function getQueryParameters(str) {
            return (str || document.location.search).replace(/(^\?)/, '').split("&").map(function (n) { return n = n.split("="), this[n[0]] = n[1], this }.bind({}))[0];
        }

        // app code
        let app = new Vue({
            el: "#app",
            data: {
                app: {
                    clientId: 'eb652d287e6e4ed4a108c5c96ed8c609',
                    baseUrl: 'https://api.spotify.com/v1/',
                    authUrl: 'https://accounts.spotify.com/authorize'
                },
                search: {
                    string: null,
                    results: null
                },
                user: {
                    id: null,
                    tokenDetails: window.location.hash ? getQueryParameters(window.location.hash.substring(1)) : null
                },
                playlist: {
                    id: null,
                    name: null,
                    tracks: null
                }
            },
            computed: {
                authed: function () {
                    return this.user.tokenDetails !== null;
                }
            },
            watch: {
                searchString: function (newVal, oldVal) {
                    if (newVal.length < 3) {
                        this.search.results = [];
                        return;
                    }
                    this.$http.get(`${this.app.baseUrl}search?q=${encodeURI(newVal)}&type=track`, { headers: { 'Authorization': `${this.user.tokenDetails.token_type} ${this.user.tokenDetails.access_token}` } }).then(response => {
                        this.search.results = response.body.tracks.items.slice(0, 3);
                    });
                }
            },
            methods: {
                selectTrack: function (track) {
                    if (this.playlist.tracks.includes(track)) return;
                    this.playlist.tracks.push(track);
                },
                createPlaylist: function () {
                    const playlist = {
                        name: this.playlist.name,
                        public: false,
                        description: 'Created with Spotify Playlist Curator'
                    }
                    this.$http.post(`${this.app.baseUrl}users/${this.user.id}/playlists`, JSON.stringify(playlist), { headers: { 'Authorization': `${this.user.tokenDetails.token_type} ${this.user.tokenDetails.access_token}`, 'Content-Type': 'application/json' } }).then(response => {
                        this.playlist.id = response.body.id;
                    });
                },
                addSongsToPlaylist: function () {
                    this.$http.put(`${this.app.baseUrl}users/${this.user.id}/playlists/${this.playlist.id}/tracks`, JSON.stringify({ uris: this.playlist.tracks }), { headers: { 'Authorization': `${this.user.tokenDetails.token_type} ${this.user.tokenDetails.access_token}`, 'Content-Type': 'application/json' } }).then(response => {
                        this.playlist.id = response.body.id;
                    });
                },
                auth: function () {
                    window.location.replace(`${this.app.authUrl}?scope=playlist-modify-private&response_type=token&client_id=${this.app.clientId}&redirect_uri=http%3A%2F%2F127.0.0.1%3A8080`);
                }
            },
            created: function () {
                this.$http.get(`${this.app.baseUrl}me`, { headers: { 'Authorization': `${this.user.tokenDetails.token_type} ${this.user.tokenDetails.access_token}` } }).then(response => {
                    this.user.id = response.body.id;
                });
            }
        });
    </script>
</body>

</html>