<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Playlist Curator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

    <h1>Playlist Curator</h1>

    <div id="app">

        <div class="debug" style="position:fixed;top:0;right:0;border:1px solid red;width:30%;" v-if="tokenDetails">
            <h3>Debug</h3>
            <br> Token: {{ tokenDetails.access_token }}
            <br> Expires In: {{ tokenDetails.expires_in }}
            <br> Token Type: {{ tokenDetails.token_type }}
        </div>

        <div class="explorer">
            <label>Search</label>
            <input type="text" id="searchString" v-model="searchString">
            <ul>
                <li v-for="track in tracklist">
                    {{ track.name }} - {{ track.artists[0].name }}
                    <button v-on:click="selectTrack(track.uri)">Add</button>
                </li>
            </ul>
        </div>

        <div class="playlist">
            <h2>Playlist</h2>
            <label>Name: </label>
            <input type="text" id="playlistName" v-model="playlistName">
            <ul>
                <li v-for="track in selectedTracks">
                    {{ track }}
                </li>
            </ul>
        </div>

        <div class="controls">
            <button v-on:click="createPlaylist()">
                Create Playlist
            </button>
            <button v-on:click="addSongsToPlaylist()">
                Add Songs To Playlist
            </button>
            <button v-on:click="auth()" v-if="! authed">
                Auth
            </button>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>

    <script>
        // utility method
        function getQueryParameters(str) {
            return (str || document.location.search).replace(/(^\?)/, '').split("&").map(function (n) { return n = n.split("="), this[n[0]] = n[1], this }.bind({}))[0];
        }

        // app config
        const clientId = 'eb652d287e6e4ed4a108c5c96ed8c609';
        const urls = {
            baseUrl: 'https://api.spotify.com/v1/',
            authUrl: 'https://accounts.spotify.com/authorize'
        };

        // app code
        let app = new Vue({
            el: "#app",
            data: {
                searchString: '',
                tracklist: [],
                selectedTracks: [],
                playlistId: '',
                playlistName: '',
                userId: '',
                tokenDetails: window.location.hash ? getQueryParameters(window.location.hash.substring(1)) : null
            },
            computed: {
                authed: function () {
                    return this.tokenDetails !== null;
                }
            },
            watch: {
                searchString: function (newVal, oldVal) {
                    if (newVal.length < 3) {
                        this.tracklist = [];
                        return;
                    }
                    this.$http.get(`${urls.baseUrl}search?q=${encodeURI(newVal)}&type=track`, { headers: { 'Authorization': `${this.tokenDetails.token_type} ${this.tokenDetails.access_token}` } }).then(response => {
                        this.tracklist = response.body.tracks.items.slice(0, 3);
                    });
                }
            },
            methods: {
                selectTrack: function (track) {
                    if (this.selectedTracks.includes(track)) return;
                    this.selectedTracks.push(track);
                },
                createPlaylist: function () {
                    const playlist = {
                        name: this.playlistName,
                        public: false,
                        description: 'Created with Spotify Playlist Curator'
                    }
                    this.$http.post(`${urls.baseUrl}users/${this.userId}/playlists`, JSON.stringify(playlist), { headers: { 'Authorization': `${this.tokenDetails.token_type} ${this.tokenDetails.access_token}`, 'Content-Type': 'application/json' } }).then(response => {
                        this.playlistId = response.body.id;
                    });
                },
                addSongsToPlaylist: function () {
                    this.$http.put(`${urls.baseUrl}users/${this.userId}/playlists/${this.playlistId}/tracks`, JSON.stringify({ uris: this.selectedTracks }), { headers: { 'Authorization': `${this.tokenDetails.token_type} ${this.tokenDetails.access_token}`, 'Content-Type': 'application/json' } }).then(response => {
                        this.playlistId = response.body.id;
                    });
                },
                auth: function () {
                    window.location.replace(`${urls.authUrl}?scope=playlist-modify-private&response_type=token&client_id=${clientId}&redirect_uri=http%3A%2F%2F127.0.0.1%3A8080`);
                }
            },
            created: function () {
                this.$http.get(`${urls.baseUrl}me`, { headers: { 'Authorization': `${this.tokenDetails.token_type} ${this.tokenDetails.access_token}` } }).then(response => {
                    this.userId = response.body.id;
                });
            }
        });
    </script>
</body>

</html>